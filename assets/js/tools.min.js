let currentHover=null,playIndex=0,partIndex=0,nextPartIndex=0,playlist=[],partlist={},playing=false,downloading=false,volume=0,previousVolume=null,repeatMode=0,touched=false,touchedElement=null,currentButton=null;let backgroundProcesses=[];let sliderTimeout=null,controlsTimeout=null,secondsInterval=null,timelineTimeout=null,searchTimeout=null;let pageURL=window.location.protocol+"//"+window.location.host+new URL(window.location).pathname;let page,prevPage,mouseX=0,mouseY=0;let theme=getCookie("theme");if(!theme)theme="light";document.getElementsByTagName("html")[0].setAttribute("data-theme",theme);HTMLElement.prototype.animateCallback=function(keyframes,options,callback){let animation=this.animate(keyframes,options);animation.onfinish=function(){callback()}};document.addEventListener("mousemove",e=>{mouseX=e.clientX;mouseY=e.clientY});const bindEvent=(eventNames,selectors,handler)=>{eventNames.split(", ").forEach(eventName=>{document.addEventListener(eventName,function(event){selectors.split(", ").forEach(selector=>{if(event.target.matches(selector+", "+selector+" *")){let element=event.target.closest(selector);switch(eventName){case"click":if(!element.onclick){element.onclick=handler;handler.apply(element,arguments)}break;case"play":if(!element.onplay){element.onplay=handler;handler.apply(element,arguments)}break;case"timeupdate":if(!element.ontimeupdate){element.ontimeupdate=handler;handler.apply(element,arguments)}break;case"mouseout":if(!element.onmouseout){element.onmouseout=handler;handler.apply(element,arguments)}break;default:handler.apply(element,arguments);break}}})},false)})};document.addEventListener("mouseover",function(e){currentHover=e.target});const prev=(element,className="")=>{let prev=element.previousElementSibling;if(!className||prev.classList.contains(className))return prev};function httpGet(url){let xmlHttp=new XMLHttpRequest;xmlHttp.open("GET",url,false);try{xmlHttp.send();return xmlHttp.responseText}catch(e){return"<body>There was an error performing this request. Please try again later or reloading the page.</body>"}}function updateSearch(){let search=document.getElementById("search").querySelector("input");if(search.style.width!==""){setTimeout(function(){showSearch()},200)}}function createSilence(seconds=1){const sampleRate=8e3;const numChannels=1;const bitsPerSample=8;const blockAlign=numChannels*bitsPerSample/8;const byteRate=sampleRate*blockAlign;const dataSize=Math.ceil(seconds*sampleRate)*blockAlign;const chunkSize=36+dataSize;const byteLength=8+chunkSize;const buffer=new ArrayBuffer(byteLength);const view=new DataView(buffer);view.setUint32(0,1380533830,false);view.setUint32(4,chunkSize,true);view.setUint32(8,1463899717,false);view.setUint32(12,1718449184,false);view.setUint32(16,16,true);view.setUint16(20,1,true);view.setUint16(22,numChannels,true);view.setUint32(24,sampleRate,true);view.setUint32(28,byteRate,true);view.setUint16(32,blockAlign,true);view.setUint16(34,bitsPerSample,true);view.setUint32(36,1684108385,false);view.setUint32(40,dataSize,true);for(let offset=44;offset<byteLength;offset++){view.setUint8(offset,128)}const blob=new Blob([view],{type:"audio/wav"});return URL.createObjectURL(blob)}function htmlToElement(html){let parser=new DOMParser;return parser.parseFromString(html,"text/html")}function setActiveNavbar(){document.querySelectorAll("#navigation li.active").forEach(function(element){element.classList.remove("active")});document.querySelector("[data-page='"+page+"']").parentElement.classList.add("active")}function dataIncludeReplace(object){let elementsInclude=object.querySelectorAll("[data-include]");let elementsReplace=object.querySelectorAll("[data-replace]");for(let elementInclude of elementsInclude){let url=elementInclude.getAttribute("data-include");let data=htmlToElement(httpGet(url));let dataElementsInclude=data.querySelectorAll("[data-include]");let dataElementsReplace=data.querySelectorAll("[data-replace]");if(dataElementsInclude.length||dataElementsReplace.length){dataIncludeReplace(data)}elementInclude.innerHTML=data.body.innerHTML;elementInclude.removeAttribute("data-include")}for(let elementReplace of elementsReplace){let url=elementReplace.getAttribute("data-replace");let data=htmlToElement(httpGet(url));let dataElementsInclude=data.querySelectorAll("[data-include]");let dataElementsReplace=data.querySelectorAll("[data-replace]");if(dataElementsInclude.length||dataElementsReplace.length){dataIncludeReplace(data)}elementReplace.outerHTML=data.body.innerHTML}}function tryParseJSON(jsonString){try{let o=JSON.parse(jsonString);if(o&&typeof o==="object"){return o}}catch(e){}return false}function showNotification(message,time){let content=document.getElementById("content");let notifications=document.getElementsByClassName("notification");for(let notification of notifications){let notificationStyle=window.getComputedStyle(notification);let notificationPosition=notification.getBoundingClientRect();let bottom=Number(notificationStyle.bottom.replace("px",""));notification.style.bottom=bottom+notificationPosition.height+5+"px"}let notification=document.createElement("div");notification.classList.add("notification");notification.textContent=message;notification.style.left=content.getBoundingClientRect().left+10+"px";content.parentNode.appendChild(notification);let player=document.getElementById("player");let playerStyle=window.getComputedStyle(player);let timeoutOpacity,timeoutBottom;notification.animateCallback([{opacity:0},{opacity:1}],{duration:100,fill:"forwards"},function(){timeoutOpacity=setTimeout(()=>{removeOpacityNotification(notification)},time)});if(playerStyle.display!=="none"){if(getWidth()>500){notification.animateCallback([{bottom:"10px"},{bottom:"110px"}],{duration:100},function(){notification.style.bottom="110px";timeoutBottom=setTimeout(function(){hideNotification(notification)},time)})}else{notification.style.bottom="110px"}}notification.onmouseover=function(){clearTimeout(timeoutOpacity);clearTimeout(timeoutBottom)};notification.onmouseout=function(){removeOpacityNotification(notification);hideNotification(notification)}}function removeOpacityNotification(notification){notification.animateCallback([{opacity:1},{opacity:0}],{duration:100,fill:"forwards"},function(){notification.remove()})}function hideNotification(notification){let position=window.getComputedStyle(notification);notification.animateCallback([{bottom:position.bottom},{bottom:"10px"}],{duration:100},function(){notification.style.bottom="10px"})}function isTouchScreen(){return window.matchMedia("(hover: none)").matches}function getWidth(){return Math.max(document.body.scrollWidth,document.documentElement.scrollWidth,document.body.offsetWidth,document.documentElement.offsetWidth,document.documentElement.clientWidth)}function getCookie(name){let value=`; ${document.cookie}`,parts=value.split(`; ${name}=`);if(parts.length===2){return parts.pop().split(";").shift()}else{return""}}function setCookie(name,value,expiresAt=""){document.cookie=name+"="+value+"; Expires="+expiresAt+"; Path=/; SameSite=Lax"}function ucFirst(string){return String(string).charAt(0).toUpperCase()+string.slice(1)}function getMinutesAndSeconds(time){let minutes=Math.floor(time/60);let seconds=time-minutes*60;minutes=("0"+minutes).slice(-2);seconds=("0"+seconds).slice(-2);return minutes+":"+seconds}function createControls(elementClass,actions){let controls=document.createElement("div");controls.classList.add(elementClass);for(let action of actions){let icon;switch(action){case"play":icon=document.createElement("i");icon.title="Play this song";icon.classList.add("fas","fa-play");break;case"add":icon=document.createElement("div");icon.title="Add this song to the queue";icon.classList.add("listAdd");let listIcon=document.createElement("i"),plusIcon=document.createElement("i");listIcon.classList.add("fas","fa-list");plusIcon.classList.add("fas","fa-plus");icon.appendChild(listIcon);icon.appendChild(plusIcon);break}controls.appendChild(icon)}return controls}function removeControls(elementClass){let controls=document.getElementsByClassName(elementClass);for(let control of controls){control.remove()}}function setVolumeIcon(volumeIcon,volumeSlider){volumeIcon.classList.remove("fa-volume-*");if(volumeSlider.value>=50)volumeIcon.classList.add("fa-volume-up");else if(volumeSlider.value>=1)volumeIcon.classList.add("fa-volume-down");else volumeIcon.classList.add("fa-volume-off")}function hideVolumeSlider(){clearTimeout(sliderTimeout);sliderTimeout=setTimeout(function(){document.getElementsByClassName("volumeBackground")[0].classList.remove("show");touched=false},2e3)}function hidePlaylist(body,queueView,angleIcon){body.style.overflowY="initial";angleIcon.animate([{transform:"rotate(-180deg)"},{transform:"rotate(0deg)"}],{duration:200,fill:"forwards"});queueView.animateCallback([{top:"60px"},{top:"100%"}],{duration:300,fill:"forwards"},function(){queueView.classList.remove("show")});angleIcon.setAttribute("data-angle","down")}function setVolume(volume){let volumeSlider=document.getElementById("player").querySelector(".volumeSlider");previousVolume=null;playlist[playIndex]["player"].setVolume(volume);volumeSlider.value=volume*100;let volumeIcon=prev(volumeSlider.closest(".volumeBackground"));setVolumeIcon(volumeIcon,volumeSlider);setCookie("volume",volume);hideVolumeSlider()}function muteAudio(e=null){if(!isTouchScreen()||touched){let volumeSlider=document.getElementById("player").querySelector(".volumeSlider"),volumeIcon=prev(volumeSlider.closest(".volumeBackground"));if(e&&e.target===volumeSlider)return;if(previousVolume){volumeSlider.value=previousVolume*100;setVolumeIcon(volumeIcon,volumeSlider);volume=previousVolume;previousVolume=null;setCookie("muted",false)}else{volumeIcon.classList.remove("fa-volume-*");volumeIcon.classList.add("fa-volume-mute");previousVolume=volume;volumeSlider.value=volume=0;setCookie("muted",true)}if(typeof playlist[playIndex]!=="undefined")playlist[playIndex]["player"].setVolume(volume);hideVolumeSlider()}else touched=true}function showSearch(){let searchToggler=document.getElementsByClassName("search-toggler")[0];let input=searchToggler.closest(".icons").querySelector("#search input");let width="";if(getWidth()<=500)width=getWidth()-145+"px";else if(getWidth()<=1150)width=getWidth()-215+"px";input.style.width=width;input.focus();document.getElementById("menu").classList.remove("show")}function play(diffSong=false){let player=document.getElementById("player");let song=playlist[playIndex];let gapless=song["player"];gapless.setVolume(volume);gapless.play();playing=true;if(diffSong){let split=song["length"].split(":"),length=Number(split[0])*60+Number(split[1]);let songLength=document.getElementById("timeInfo").querySelector("#length");let queueView=document.getElementById("queueView");let cover=queueView.querySelector("#playingCover").querySelector("img");cover.src=song["cover"];songLength.textContent=song["length"];player.querySelector("#timeline").max=length;MSAPI.pause();MSAPI.load();MSAPI.src=createSilence(length);MSAPI.currentTime=0;player.querySelector("#name").innerHTML="<div class='truncate'>"+"<div class='content' title='"+song["name"]+"'>"+song["name"]+"</div>"+"<div class='spacer'>"+song["name"]+"</div>"+"<span>&nbsp;</span>"+"</div>";player.querySelector("#artist").innerHTML="<div class='truncate'>"+"<div class='content' title='"+song["artist"]+"'>"+song["artist"]+"</div>"+"<div class='spacer'>"+song["artist"]+"</div>"+"<span>&nbsp;</span>"+"</div>";if("mediaSession"in navigator){let song=playlist[playIndex];let mouseUpEvent=new Event("mouseup",{bubbles:true,cancelable:true});navigator.mediaSession.metadata=new MediaMetadata({title:song["name"],artist:song["artist"],artwork:[{src:song["cover"],type:"image/png"}]});navigator.mediaSession.setActionHandler("play",function(){play()});navigator.mediaSession.setActionHandler("pause",function(){pauseSong()});navigator.mediaSession.setActionHandler("previoustrack",function(){previousSong()});navigator.mediaSession.setActionHandler("nexttrack",function(){nextSong()});navigator.mediaSession.setActionHandler("stop",function(){pauseSong()});navigator.mediaSession.setActionHandler("seekbackward",function(){let timeline=document.getElementById("timeline");timeline.value=Number(timeline.value)-10;timeline.dispatchEvent(mouseUpEvent)});navigator.mediaSession.setActionHandler("seekforward",function(){let timeline=document.getElementById("timeline");timeline.value=Number(timeline.value)+10;timeline.dispatchEvent(mouseUpEvent)});navigator.mediaSession.setActionHandler("seekto",function(details){onTimelineRelease(details.seekTime)})}let data=tryParseJSON(httpGet(pageURL+"system/info/"+song["id"]));let infoBox=queueView.querySelector("#info");if(Object.keys(data).length){infoBox.innerHTML="";for(let info of Object.values(data)){infoBox.innerHTML+="<h3>"+info["name"]+"</h3>"+"<p>"+info["description"]+"</p>"}}else{infoBox.innerHTML="<h3>No description found.</h3>"}}player.style.display="initial";let title=document.querySelector("title");title.textContent=song["name"]+" - "+title.textContent.split(" - ")[1];if(!secondsInterval){secondsInterval=setInterval(function(){let timeline=document.getElementById("timeline");let currentPosition=getCurrentPartTime();if(currentPosition){let position=currentPosition+partlist[playIndex][partIndex]["from"];timeline.value=position;MSAPI.currentTime=position;if("mediaSession"in navigator){navigator.mediaSession.setPositionState({duration:MSAPI.duration,playbackRate:MSAPI.playbackRate,position:MSAPI.currentTime})}}},1e3)}}function nextSongIndex(){let nextIndex=Number(playIndex)+1;switch(repeatMode){case 1:if(typeof playlist[nextIndex]==="undefined")return 0;break;case 2:return playIndex}return nextIndex}function previousSongIndex(){let previousIndex=Number(playIndex)-1;switch(repeatMode){case 0:case 1:if(typeof playlist[previousIndex]==="undefined")return 0;break;case 2:return playIndex}return previousIndex}function playPauseButton(option="pause"){let player=document.getElementById("player");let button=player.querySelector("#dynamicButton");if(currentButton!==option){if(option==="play"){button.innerHTML='<i class="fas fa-pause"></i>'}else if(option==="pause"){button.innerHTML='<i class="fa fa-play"></i>'}else if(option==="load"){button.innerHTML='<div class="lds-ring"><div></div><div></div><div></div><div></div></div>'}currentButton=option}}function getCurrentPartTime(){try{return playlist[playIndex]["player"].playlist.sources[partlist[playIndex][partIndex]["gid"]].getPosition()/1e3}catch(e){return 0}}function clearSong(index){if(typeof playlist[index]["player"]!=="undefined"){playlist[index]["player"].stop();playlist[index]["player"].removeAllTracks()}}function clearSongs(){for(let index of Object.keys(playlist)){clearSong(index)}}function resetSong(index){let gapless=playlist[index]["player"];if(gapless.isPlaying())gapless.stop();gapless.gotoTrack(0);for(let part of Object.values(partlist[index])){if(typeof gapless.playlist.sources[part["gid"]]!=="undefined")gapless.playlist.sources[part["gid"]].setPosition(0)}}function pauseSong(){if(playing){playPauseButton("pause");playlist[playIndex]["player"].pause();MSAPI.pause();clearInterval(secondsInterval);secondsInterval=null;playing=false}}function onTimelinePress(){let timeInfo=document.getElementById("timeInfo");timeInfo.style.display="initial";playPauseButton("pause");clearInterval(secondsInterval);secondsInterval=null;playlist[playIndex]["player"].pause()}function onTimelineMove(rangeEvent){let timeInfo=document.getElementById("timeInfo");let measurementTimeInfo=timeInfo.getBoundingClientRect();let measurementRange=rangeEvent.target.getBoundingClientRect();let leftPos=mouseX-measurementTimeInfo["width"]/2;if(leftPos<0)leftPos=0;else if(leftPos+measurementTimeInfo["width"]>getWidth())leftPos=getWidth()-measurementTimeInfo["width"];timeInfo.style.top=measurementRange["top"]-measurementTimeInfo["height"]-10+"px";timeInfo.style.left=leftPos+"px";let currentTime=timeInfo.querySelector("#current");currentTime.textContent=getMinutesAndSeconds(rangeEvent.target.value)}function generatePlaylistCover(song){let info={cover:document.createElement("div"),artists:""};info["cover"].classList.add("cover");for(let i=0;i<4;i++){let songID=song["playlist"][i];let data=tryParseJSON(httpGet(pageURL+"system/song/"+songID));info["cover"].innerHTML+="<img src='"+data["cover"]+"' alt='Cover'/>";info["artists"]+=data["artist"]+", "}info["artists"]=info["artists"].substring(0,info["artists"].length-2)+" and more..";return info}function generateTableHead(columns){let thead=document.createElement("thead");let row=document.createElement("tr");for(let column of columns){let th=document.createElement("th");th.textContent=ucFirst(column);row.appendChild(th)}thead.appendChild(row);return thead}function generateTableBody(data,columns,tbody=null,cover=null){if(!tbody)tbody=document.createElement("tbody");for(let row of Object.values(data)){let tableRow=document.createElement("tr");if(typeof row["id"]!=="undefined")tableRow.setAttribute("data-id",row["id"]);row=removeFromObject(row,["id","category","player"]);generateTableRow(row,tableRow,columns,cover);tbody.appendChild(tableRow)}return tbody}function generateTableRow(rowData,tableRow,columns,cover=null){if(typeof rowData["playlist"]==="undefined"){for(let column of columns){column=column.toLowerCase();let element=typeof rowData[column]!=="undefined"?rowData[column]:"";if(column==="cover"){if(cover!==null){tableRow.innerHTML+='<td><div class="cover" style="background-image: url(\''+cover+"'); background-position-x: -"+rowData["coverPos"]/200*35+'px"></div></td>'}else{tableRow.innerHTML+="<td><img src='"+rowData["cover"]+"' alt='cover' /></td>"}}else{let truncate=document.createElement("div");truncate.classList.add("truncate");let content=document.createElement("div");content.setAttribute("data-title",element);content.classList.add("content");content.textContent=element;switch(element){case"ACCEPT":content.classList.add("green");break;case"DROP":content.classList.add("red");break}let spacer=document.createElement("div");spacer.classList.add("spacer");spacer.textContent=element;let span=document.createElement("span");span.innerHTML="&nbsp;";truncate.appendChild(content);truncate.appendChild(spacer);truncate.appendChild(span);let tableData=document.createElement("td");tableData.appendChild(truncate);tableRow.appendChild(tableData)}}}else{let info=generatePlaylistCover(rowData);let td=document.createElement("td");td.appendChild(info["cover"]);tableRow.appendChild(td);tableRow.classList.add("playlist");tableRow.innerHTML+="<td>"+rowData["name"]+"</td>"+"<td colspan='2'>"+"<div class='truncate'>"+"<div class='content' data-title='"+info["artists"]+"'>"+info["artists"]+"</div>"+"<div class='spacer'>"+info["artists"]+"</div>"+"<span>&nbsp;</span>"+"</div>"+"</td>"}}function removeFromObject(object,toRemove="",recursive=true){let cleaned;if(object instanceof Object&&object instanceof Array){cleaned=[];for(let value of object){if(value!==toRemove&&!toRemove.includes(value))cleaned.push(value)}}else{cleaned={};for(let[key,value]of Object.entries(object)){if(key!==toRemove&&!toRemove.includes(key)){if(typeof value==="object"&&recursive){cleaned[key]=removeFromObject(Object.assign({},value),toRemove)}else{if(!isNum(key))cleaned[key]=value;else{if(!Array.isArray(cleaned))cleaned=[];cleaned.push(value)}}}}}return cleaned}function isNum(val){return!isNaN(val)}function getColumns(data,level=0,start=0){let columns=[];for(let value of Object.values(data)){if(typeof value==="object"&&start<level){let tempColumns=getColumns(value,level,start+1);if(tempColumns.length>columns.length)columns=tempColumns}if(start>=level)return Object.keys(data)}return columns}function getPartLength(index){return Number((playlist[playIndex]["player"].playlist.sources[index].getLength()/1e3).toFixed())}function getPartLengthCallback(index,callback){let length=0;let interval=setInterval(function(){if(typeof playlist[playIndex]["player"].playlist.sources[index]!=="undefined"){length=Number((playlist[playIndex]["player"].playlist.sources[index].getLength()/1e3).toFixed());if(length){clearInterval(interval);callback(length)}}},50)}function getPartIndexByTime(time){for(let[index,part]of Object.entries(partlist[playIndex])){if(part["from"]<=time&&part["till"]>=time)return[part["from"],part["till"],Number(index)]}return[undefined,undefined,undefined]}function getPartIndexByStartTime(time){for(let[index,part]of Object.entries(partlist[playIndex])){if(part["from"]===time)return[part["from"],part["till"],Number(index)]}return[undefined,undefined,undefined]}function findMissingLengthByCurrentPart(){let currentLength=getPartLength(partIndex);let currentEnding=partlist[playIndex][partIndex]["till"];for(let part of Object.values(partlist[playIndex])){let missingLength=part["from"]-currentEnding-1;if(missingLength<=currentLength&&missingLength>0)return missingLength}return null}